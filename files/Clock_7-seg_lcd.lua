local a={["0"]=192,["1"]=249,["2"]=164,["3"]=176,["4"]=153,["5"]=146,["6"]=130,["7"]=248,["8"]=128,["9"]=144,["-"]=191,["_"]=247,["t"]=135,["d"]=151}local function b(c)local d={}for e in c:gmatch("(.)")do if _LCD_7SEG.type=="anode"then d[#d+1]=a[e]and a[e]or 255 else d[#d+1]=a[e]and 255-a[e]or 0 end end;return d end;local function f(g)_LCD_7SEG={}_LCD_7SEG.latch=g.latch;_LCD_7SEG.qty=g.qty;_LCD_7SEG.type=g.type;_LCD_7SEG.speed=type(g.speed)=="number"and g.speed or 500;spi.setup(1,spi.MASTER,spi.CPOL_LOW,spi.CPHA_LOW,8,8)gpio.mode(_LCD_7SEG.latch,gpio.OUTPUT)return true end;local function h(i)_,_,x=spi.send(1,0,i)gpio.write(_LCD_7SEG.latch,gpio.HIGH)gpio.write(_LCD_7SEG.latch,gpio.LOW)return true end;return function(g,j)local d,c=false;if g.init then d=f(g.init)end;if _LCD_7SEG then if g.set then c=g.set;c=#c<_LCD_7SEG.qty and string.rep(" ",_LCD_7SEG.qty-#c)..c or c;d=h(b(c))end;if g.step then if _LCD_7SEG.st then return false end;_LCD_7SEG.st=true;local k=string.rep(" ",_LCD_7SEG.qty)c=k..g.step..k;_LCD_7SEG.tmr=tmr.create()_LCD_7SEG.tmr:register(g.speed or _LCD_7SEG.speed,tmr.ALARM_AUTO,function(g)h(b(c:sub(1,_LCD_7SEG.qty)))c=c:sub(2,#c)if#c<_LCD_7SEG.qty then _LCD_7SEG.st=nil;g:unregister()if j then j(true)end end end)_LCD_7SEG.tmr:start()d=true end end;return d end
